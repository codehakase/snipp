<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screenshot Captured</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Hide scrollbars */
    ::-webkit-scrollbar {
      display: none;
    }
    
    html, body {
      -ms-overflow-style: none;  /* Internet Explorer 10+ */
      scrollbar-width: none;  /* Firefox */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: transparent;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      overflow: hidden; /* Hide scrollbars */
    }

    .popup-container {
      width: 320px;
      background: rgba(250, 250, 250, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.12),
        0 2px 8px rgba(0, 0, 0, 0.08);
      animation: slideIn 0.2s ease-out;
    }

    .thumbnail-preview {
      width: 280px;
      height: 180px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #f8f9fa;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }

    .info-section {
      margin-top: 12px;
      text-align: center;
    }

    .info-title {
      font-size: 13px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
      margin-bottom: 2px;
    }

    .info-path {
      font-size: 11px;
      font-weight: 400;
      color: rgba(0, 0, 0, 0.5);
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
    }

    .action-buttons {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .btn {
      height: 28px;
      padding: 0 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(180deg, #007AFF 0%, #0051D5 100%);
      color: white;
      box-shadow: 0 1px 3px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(180deg, #0051D5 0%, #003DA5 100%);
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.4);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 122, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.04);
      color: rgba(0, 0, 0, 0.75);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.08);
      border-color: rgba(0, 0, 0, 0.12);
    }

    .btn-secondary:active {
      background: rgba(0, 0, 0, 0.12);
    }

    .btn-success {
      background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
      color: white;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-12px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .popup-container.dismissing {
      animation: slideOut 0.2s ease-in forwards;
    }

    @keyframes slideOut {
      to {
        opacity: 0;
        transform: translateY(-8px) scale(0.98);
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .popup-container {
        background: rgba(45, 45, 45, 0.95);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 
          0 8px 32px rgba(0, 0, 0, 0.4),
          0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .thumbnail-preview {
        border-color: rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.04);
      }

      .info-title {
        color: rgba(255, 255, 255, 0.9);
      }

      .info-path {
        color: rgba(255, 255, 255, 0.5);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.85);
        border-color: rgba(255, 255, 255, 0.12);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.18);
      }
    }
  </style>
</head>
<body>
  <div class="popup-container" id="popup">
    <img class="thumbnail-preview" id="thumbnail" src="" alt="Screenshot preview" />
    
    <div class="info-section">
      <div class="info-title">Screenshot captured</div>
      <div class="info-path" id="file-path">Ready to save or copy</div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" id="save-btn">Save to Desktop</button>
      <button class="btn btn-secondary" id="copy-btn">Copy</button>
      <button class="btn btn-secondary" id="delete-btn">Delete</button>
    </div>
  </div>

  <script>
    console.log('üöÄ Memory-first popup loading...');
    
    let currentScreenshotData = null;

    // Setup immediately
    setupPopup();

    function setupPopup() {
      console.log('Setting up memory-first popup...');
      
      // Setup button handlers immediately
      setupButtonHandlers();
      
      // Setup Tauri event listener
      if (window.__TAURI__) {
        console.log('Tauri APIs available, setting up event listener');
        setupTauriEventListener();
      } else {
        console.log('Waiting for Tauri APIs...');
        let attempts = 0;
        const checkTauri = () => {
          attempts++;
          if (window.__TAURI__) {
            console.log('Tauri APIs loaded after', attempts, 'attempts');
            setupTauriEventListener();
          } else if (attempts < 20) {
            setTimeout(checkTauri, 50);
          } else {
            console.error('Tauri APIs not available after 20 attempts');
          }
        };
        checkTauri();
      }
    }

    function setupTauriEventListener() {
      try {
        const { listen } = window.__TAURI__.event;
        
        // Listen for screenshot data with base64 image
        listen('screenshot-data', (event) => {
          console.log('üì∏ Received screenshot data:', event.payload);
          currentScreenshotData = event.payload;
          loadScreenshotFromMemory(currentScreenshotData);
        }).catch(error => {
          console.error('‚ùå Failed to listen for screenshot-data:', error);
        });
        
        console.log('‚úÖ Event listener setup complete');
        
      } catch (error) {
        console.error('‚ùå Error setting up Tauri event listener:', error);
      }
    }

    function loadScreenshotFromMemory(screenshotData) {
      console.log('üì∑ Loading screenshot from memory data...');
      const thumbnail = document.getElementById('thumbnail');
      const filePath = document.getElementById('file-path');
      
      if (!thumbnail || !filePath) {
        console.error('‚ùå Missing DOM elements');
        return;
      }
      
      // Load base64 image directly - no file system dependency!
      const base64Src = `data:image/png;base64,${screenshotData.base64_image}`;
      console.log('üñºÔ∏è Setting image source to base64 data...');
      
      thumbnail.src = base64Src;
      thumbnail.onload = () => {
        console.log('‚úÖ Image loaded successfully from base64 data');
        thumbnail.style.display = 'block';
      };
      thumbnail.onerror = (error) => {
        console.error('‚ùå Image failed to load:', error);
        showImagePlaceholder();
      };
      
      // Update file info
      filePath.textContent = `${screenshotData.filename} (in memory)`;
      
      console.log('üì∑ Screenshot loaded successfully');
    }

    function showImagePlaceholder() {
      const thumbnail = document.getElementById('thumbnail');
      thumbnail.style.backgroundColor = '#e1e5e9';
      thumbnail.style.display = 'flex';
      thumbnail.style.alignItems = 'center';
      thumbnail.style.justifyContent = 'center';
      thumbnail.alt = 'Screenshot preview unavailable';
    }

    function setupButtonHandlers() {
      console.log('üîò Setting up button handlers...');
      
      // Save button - saves from memory to disk
      const saveBtn = document.getElementById('save-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          console.log('üíæ Save button clicked');
          
          if (!currentScreenshotData) {
            console.error('‚ùå No screenshot data available');
            return;
          }
          
          try {
            if (window.__TAURI__ && window.__TAURI__.core) {
              const filePath = await window.__TAURI__.core.invoke('save_to_disk', { 
                timestamp: currentScreenshotData.timestamp 
              });
              console.log('‚úÖ Screenshot saved to:', filePath);
              
              // Update UI
              document.getElementById('file-path').textContent = filePath;
              saveBtn.textContent = 'Saved!';
              saveBtn.classList.remove('btn-primary');
              saveBtn.classList.add('btn-success');
              
              setTimeout(() => {
                closePopup();
              }, 2000);
            } else {
              console.warn('‚ö†Ô∏è Tauri invoke not available');
            }
          } catch (error) {
            console.error('‚ùå Failed to save screenshot:', error);
          }
        });
        console.log('‚úÖ Save button handler attached');
      }
      
      // Copy button - copies from memory to clipboard
      const copyBtn = document.getElementById('copy-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          console.log('üìã Copy button clicked');
          
          if (!currentScreenshotData) {
            console.error('‚ùå No screenshot data available');
            return;
          }
          
          try {
            if (window.__TAURI__ && window.__TAURI__.core) {
              await window.__TAURI__.core.invoke('copy_to_clipboard', { 
                timestamp: currentScreenshotData.timestamp 
              });
              console.log('‚úÖ Screenshot copied to clipboard');
              
              const originalText = copyBtn.textContent;
              copyBtn.textContent = 'Copied!';
              copyBtn.classList.add('btn-success');
              
              setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('btn-success');
              }, 1000);
              
            } else {
              console.warn('‚ö†Ô∏è Tauri invoke not available');
            }
          } catch (error) {
            console.error('‚ùå Failed to copy to clipboard:', error);
          }
        });
        console.log('‚úÖ Copy button handler attached');
      }
      
      // Delete button - removes from memory
      const deleteBtn = document.getElementById('delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          console.log('üóëÔ∏è Delete button clicked');
          
          if (!currentScreenshotData) {
            console.error('‚ùå No screenshot data available');
            return;
          }
          
          try {
            if (window.__TAURI__ && window.__TAURI__.core) {
              await window.__TAURI__.core.invoke('delete_from_memory', { 
                timestamp: currentScreenshotData.timestamp 
              });
              console.log('‚úÖ Screenshot deleted from memory');
              
              deleteBtn.textContent = 'Deleted!';
              deleteBtn.classList.add('btn-success');
              
              setTimeout(() => {
                closePopup();
              }, 1500);
              
            } else {
              console.warn('‚ö†Ô∏è Tauri invoke not available');
            }
          } catch (error) {
            console.error('‚ùå Failed to delete screenshot:', error);
          }
        });
        console.log('‚úÖ Delete button handler attached');
      }
      
      // Escape key handler
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          console.log('‚å®Ô∏è Escape key pressed');
          closePopup();
        }
      });
      
      
      console.log('‚úÖ All button handlers setup complete');
    }


    async function closePopup() {
      console.log('üö™ Closing popup');
      const popup = document.getElementById('popup');
      popup.classList.add('dismissing');
      
      setTimeout(async () => {
        try {
          if (window.__TAURI__ && window.__TAURI__.core) {
            await window.__TAURI__.core.invoke('close_popup_window');
          }
        } catch (error) {
          console.error('‚ùå Error closing popup:', error);
        }
      }, 200);
    }

    console.log('‚úÖ Memory-first popup script loaded successfully');
  </script>
</body>
</html>